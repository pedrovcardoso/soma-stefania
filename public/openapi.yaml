openapi: 3.0.3

info:
  title: API SOMA - Gestão de Processos
  description: |
    API backend do sistema SOMA para consulta de processos,
    documentos, integração com SEI e Azure Cognitive Search.
  version: "1.0.0"

servers:
  - url: http://10.180.168.23:5000
    description: Ambiente interno
  - url: http://localhost:5000
    description: Ambiente local

paths:

  /login:
    post:
      summary: Autenticação de usuário
      tags: [Autenticação]
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                password:
                  type: string
      responses:
        "200":
          description: Login realizado com sucesso
        "400":
          description: Login ou senha inválidos

  /processo:
    post:
      summary: Lista processos com filtros
      tags: [Processos]
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                ano_referencia:
                  type: array
                  items: { type: string }
                tipo:
                  type: array
                  items: { type: string }
                status:
                  type: array
                  items: { type: string }
                data_inicio:
                  type: string
                  format: date
                data_fim:
                  type: string
                  format: date
      responses:
        "200":
          description: Lista de processos
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/ProcessoResumo"

  /processodistintos:
    get:
      tags:
        - Processos
      summary: Listar processos distintos (SEI)
      description: >
        Retorna a lista de números de processos SEI distintos existentes
        na base de dados do TCE.
      operationId: listarProcessosDistintos
      responses:
        "200":
          description: Lista de processos retornada com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        sei:
                          type: string
                          example: "12345.01.000000/2023-11"
        "500":
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: Erro ao consultar processos

  /filtros:
    get:
      summary: Retorna valores para filtros
      tags: [Processos]
      responses:
        "200":
          description: Filtros disponíveis
          content:
            application/json:
              schema:
                type: object
                properties:
                  anos:
                    type: array
                    items: { type: string }
                  tipos:
                    type: array
                    items: { type: string }
                  status:
                    type: array
                    items: { type: string }

  /detalheProcesso:
    post:
      summary: Detalhes completos do processo
      tags: [Processos]
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [sei]
              properties:
                sei:
                  type: string
      responses:
        "200":
          description: Detalhes do processo
          content:
            application/json:
              schema:
                type: object
                properties:
                  processo:
                    $ref: "#/components/schemas/ProcessoDetalhado"
                  tags:
                    type: array
                    items:
                      $ref: "#/components/schemas/Tag"
                  sei:
                    type: object

  /listaDocumentos:
    post:
      summary: Lista documentos de um processo e auxiliares
      tags: [Documentos]
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [url_processo, sei_principal]
              properties:
                url_processo: { type: string }
                sei_principal: { type: string }
      responses:
        "200":
          description: Lista de documentos
          content:
            application/json:
              schema:
                type: object
                properties:
                  documentos:
                    type: array
                    items:
                      $ref: "#/components/schemas/Documento"

  /consultaDocumento:
    post:
      summary: Consulta documento específico
      tags: [Documentos]
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [protocolo]
              properties:
                protocolo: { type: string }
      responses:
        "200":
          description: Documento consultado
          content:
            application/json:
              schema:
                type: object
                properties:
                  sei: { type: object }
                  metadata:
                    $ref: "#/components/schemas/DocumentoMetadata"

  /manterProcesso:
    post:
      summary: Inserir, alterar ou excluir processo
      tags: [Processos]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ManterProcessoRequest"
      responses:
        "200":
          description: Operação realizada com sucesso
        "400":
          description: Erro de validação
        "404":
          description: Processo não encontrado
        "409":
          description: Conflito
        "500":
          description: Erro interno

  /uploadDocumentos:
    post:
      summary: Upload de documentos para Azure
      tags: [Documentos]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [documentos]
              properties:
                documentos:
                  type: array
                  items:
                    $ref: "#/components/schemas/UploadDocumento"
      responses:
        "200":
          description: Upload finalizado
  /manterCesta_bp:
    post:
      summary: Inserir, alterar, excluir ou consultar cestas
      tags: [ Cestas ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ManterCestaRequest"
      responses:
        "200":
          description: Operação realizada com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ManterCestaResponse"
        "201":
          description: Cesta criada com sucesso
        "400":
          description: Erro de validação
        "404":
          description: Cesta não encontrada
        "409":
          description: Conflito (registro existente ou vínculo)
        "500":
          description: Erro interno

  /mantervinculacaoCesta:
    post:
      summary: Inserir, excluir ou consultar vinculações entre cestas e processos
      tags: [ Cestas ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ManterVinculacaoCestaRequest"
      responses:
        "200":
          description: Operação realizada com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ManterVinculacaoCestaResponse"
        "201":
          description: Vinculação criada com sucesso
        "400":
          description: Erro de validação
        "409":
          description: Conflito ou erro de vínculo
        "500":
          description: Erro interno
  /ragconsulta:
    post:
      summary: Consulta inteligente via RAG (Azure OpenAI + Azure Cognitive Search)
      description: |
        Executa uma consulta utilizando abordagem RAG (Retrieval-Augmented Generation),
        com recuperação de documentos no Azure Cognitive Search e geração de resposta
        via Azure OpenAI.

        A API detecta automaticamente o tipo da pergunta:
        - **Resumo**: perguntas descritivas ou informativas
        - **Análise**: perguntas com foco em questionamentos, apontamentos,
          entendimentos ou críticas (ex: TCE)

        A resposta é gerada exclusivamente com base nos documentos recuperados.
      tags:
        - RAG
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RagConsultaRequest"
      responses:
        "200":
          description: Resposta gerada com base nos documentos recuperados
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RagConsultaResponse"
        "400":
          description: Requisição inválida
        "500":
          description: Erro interno ao processar a consulta


components:
  schemas:

    ManterProcessoRequest:
      type: object
      required: [operacao, dados]
      properties:
        operacao:
          type: string
          enum: [inserir, alterar, excluir]
        dados:
          oneOf:
            - $ref: "#/components/schemas/ProcessoInserir"
            - $ref: "#/components/schemas/ProcessoAlterar"
            - $ref: "#/components/schemas/ProcessoExcluir"

    ProcessoInserir:
      type: object
      required:
        - sei
        - descricao
        - tipo
        - dt_recebimento
        - dt_fim_prevista
        - ano_referencia
        - status
        - atribuicao
        - responsavel
      properties:
        sei: { type: string }
        descricao: { type: string }
        obs: { type: string }
        tipo: { type: string }
        dt_recebimento: { type: string, format: date }
        dt_fim_prevista: { type: string, format: date }
        dt_dilacao: { type: string, nullable: true }
        dt_resposta: { type: string, nullable: true }
        sei_dilacao: { type: string, nullable: true }
        ano_referencia: { type: string }
        status: { type: string }
        atribuicao: { type: string }
        responsavel: { type: string }

    ProcessoAlterar:
      allOf:
        - $ref: "#/components/schemas/ProcessoInserir"
        - type: object
          required: [sei_original]
          properties:
            sei_original: { type: string }

    ProcessoExcluir:
      type: object
      required: [sei]
      properties:
        sei: { type: string }

    UploadDocumento:
      type: object
      required:
        - nome
        - url
        - container
        - processo
        - data_documento
        - metadata
      properties:
        nome: { type: string }
        url: { type: string }
        container: { type: string }
        processo: { type: string }
        data_documento: { type: string }
        metadata:
          type: object
          properties:
            ano: { type: string }
            tipo: { type: string }
            categoria: { type: string }

    ProcessoResumo:
      type: object
      properties:
        status: { type: string }
        sei: { type: string }
        descricao: { type: string }
        ano_referencia: { type: string }
        dt_fim_prevista: { type: string }
        tipo: { type: string }
        atribuido: { type: string }

    ProcessoDetalhado:
      type: object
      properties:
        sei: { type: string }
        ano_referencia: { type: string }
        tipo: { type: string }
        descricao: { type: string }
        status: { type: string }
        atribuido: { type: string }
        dt_recebimento: { type: string }
        dt_fim_prevista: { type: string }
        dt_dilacao: { type: string }
        sei_dilacao: { type: string }
        dt_resposta: { type: string }
        obs: { type: string }

    Documento:
      type: object
      properties:
        nome: { type: string }
        url: { type: string }
        tipo: { type: string }
        data: { type: string }
        unidade: { type: string }
        existe_azure: { type: string }
        processo_origem: { type: string }

    DocumentoMetadata:
      type: object
      properties:
        processo: { type: string }
        numero_documento: { type: string }
        tipo: { type: string }
        categoria: { type: string }
        ordem: { type: string }
        ano: { type: string }

    Tag:
      type: object
      properties:
        id_tag: { type: integer }
        tag: { type: string }
    RagConsultaRequest:
      type: object
      required:
        - prompt
      properties:
        prompt:
          type: string
          description: Pergunta a ser respondida pelo mecanismo RAG
          example: Quais os questionamentos do TCE sobre os valores repassados em ASPS?
        filtros:
          type: object
          description: Filtros opcionais aplicados na recuperação dos documentos
          properties:
            processo:
              type: string
              example: 1234567
            numero_documento:
              type: string
              example: 76324260
            categoria:
              type: string
              example: ASPS
            tipo:
              type: string
              example: Fiscalização
            ano:
              type: string
              example: "2023"

    RagConsultaResponse:
      type: object
      properties:
        resposta:
          type: string
          description: Resposta gerada pelo modelo com base nos documentos recuperados
        documentos_utilizados:
          type: array
          description: Lista de documentos explicitamente utilizados como base da resposta
          items:
            type: string
          example:
            - "76324260"
            - "87986762"
